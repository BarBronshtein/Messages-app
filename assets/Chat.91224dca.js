import{u as b,a as v,r as d,j as m,b as e,L as I,c as D,F as C,s as T,d as F,e as U}from"./index.e4f4a655.js";import{g as j,A as B,u as M,c as E,a as N,b as L,s as w,I as y,d as W,e as $,f as z}from"./useFormRegister.1d740f0b.js";const K=({className:r})=>{const t=b(),{curChat:a}=v(n=>n.chatReducer);d.exports.useEffect(()=>{t(j(a?.userId??""))},[a?._id]);const o=v(n=>n.chatReducer.curContact),s="/chats/";return m("header",{className:`chat-header shadow-[inset_0_0_4px] shadow-[#00000033] items-center flex justify-around p-2 text-lg sm:text-xl ${r} dark:shadow-[#ffffff33]`,children:[e(I,{to:s,children:e("span",{className:"fa-solid text-blue-600 fa-arrow-left cursor-pointer hover:bg-[#4444] hover:rounded-full p-2"})}),m("div",{className:"flex grow ml-8 items-center",children:[e(B,{imgSize:"md",imgUrl:o?.photo||""}),e("span",{className:"ml-4",children:o?.fullname})]}),e("span",{className:"fa-solid fa-circle-info text-blue-600 cursor-pointer hover:bg-[#4444] p-2 hover:rounded-full hover:cursor-not-allowed"})]})},H=({txt:r,url:t,type:a,fromUser:o,id:s})=>{const n=D.getLoggedInUser(),c=new RegExp("^(http[s]?:\\/\\/(www\\.)?|ftp:\\/\\/(www\\.)?|(www\\.)?){1}([0-9A-Za-z-\\.@:%_+~#=]+)+((\\.[a-zA-Z]{2,3})+)(/(.)*)?(\\?(.)*)?"),u=r?.split(" "),p=a?{video:e("video",{className:"rounded-lg",controls:!0,src:t}),img:e("img",{loading:"lazy",className:"rounded-lg",src:t}),audio:m("audio",{controls:!0,children:[e("source",{src:t,type:"audio/webm"}),e("source",{src:t,type:"audio/mpeg"}),e("source",{src:t,type:"audio/aac"}),e("source",{src:t,type:"audio/ogg"}),e("source",{src:t,type:"audio/wav"}),"Your browser does not support the audio tag"]})}[a]:"";return e("div",{className:"msg grid py-2",style:{gridTemplateColumns:o!==n._id?"300px 1fr":"1fr 300px"},children:m("div",{className:`w-fit ${o!==n._id?"col-start-1 dark:text-white":"col-start-2 text-righ text-white justify-self-end"}`,children:[!!a&&e("div",{children:p}),r&&e("p",{className:`p-3 rounded-full ${o!==n._id?"bg-[#E4E6EB] dark:bg-[#3E4042]":"bg-[rgb(0,132,255)]"}`,children:u.map((l,f)=>l.match(c)?e("a",{target:"_blank",className:"underline",href:l,children:l+" "},l+f+s):e("span",{children:l+" "},l+f+s))})]})})},P=()=>{const r=d.exports.useRef(null),t=()=>{const s=r.current;s.scrollTop=s.scrollHeight},{curChat:a}=v(s=>s.chatReducer);d.exports.useEffect(()=>{t()},[a?._id,a?.messages.length]);const o=a?.messages;return e("div",{ref:r,className:"msg-list grow px-4 py-2 overflow-y-auto",children:o&&o.map(s=>e(H,{fromUser:s.fromUser,id:s.id,txt:s.txt,type:s.type,url:s.url},s.id))})};let g,R;const G=()=>{const r=d.exports.useRef([]),[t,a]=d.exports.useState("idle"),[o,s]=d.exports.useState(null),[n,c]=d.exports.useState("");return{startRecording:()=>{t==="idle"&&navigator.mediaDevices.getUserMedia({audio:!0}).then(p=>{R=p,g=new MediaRecorder(p),g.start(),g.onstart=()=>a("recording"),g.ondataavailable=({data:l})=>r.current.push(l)}).catch(p=>c(p))},stopRecording:()=>{t!=="idle"&&(g.stop(),g.onstop=()=>{const p=new Blob(r.current,{type:"audio/webm;"});r.current=[],p.id=M.makeId(),s(p),a("idle"),R.getAudioTracks().forEach(l=>l.stop())})},audioResult:o,errorMessage:n,status:t}};const O=()=>{const r=b(),{curChat:t,chats:a}=v(i=>i.chatReducer),o=a?.find(i=>i.chatId===t?._id),{startRecording:s,stopRecording:n,audioResult:c,status:u}=G();return d.exports.useEffect(()=>{if(!c)return;const i=E.getEmpyMessage();r(N({...i,file:c,type:"audio",timestamp:Date.now()},t._id,o))},[c?.id]),e(C,{children:e("span",{title:"Click and Hold",onTouchStart:()=>s(),onMouseDown:()=>s(),onTouchEnd:()=>n(),onMouseUp:()=>n(),className:`fa-solid fa-microphone ${u==="idle"?"":"blink"} cursor-pointer hover:bg-[#4444] hover:rounded-full h-fit p-2`})})};function V(){return new Worker("/Messages-app/assets/base64.worker.532800d0.js")}const Z=({file:r,clearFile:t})=>{const a="absolute bottom-14 left-[50%] translate-x-[-50%]",o="fa-solid cursor-pointer fa-times absolute bottom-32 right-[-15%]",s="max-w-[350px] object-contain h-[150px]",[n,c]=d.exports.useState(null),u=b();return d.exports.useEffect(()=>{if(!r)return;const i=new V;return i.postMessage(r),i.onmessage=p=>{const{data:{type:l,data:f}}=p;return l==="success"?c(f):(t(),u(T({type:"error",txt:f})))},()=>{i.terminate()}},[r]),r.type.startsWith("video/")&&n?m("div",{className:a,children:[e("video",{className:s,controls:!0,src:n}),e("span",{onClick:()=>t(),className:o})]}):r.type.startsWith("image/")&&n?m("div",{className:a,children:[e("img",{className:s,src:n,alt:""}),e("span",{onClick:()=>t(),className:o})]}):n===null?e("div",{className:a,children:e(F,{})}):e("div",{className:"absolute bottom-14",children:"File is not supported"})},k=({file:r,setFile:t,className:a,capture:o})=>{const s=d.exports.useRef(null),n=u=>{const i=u.target.files?.[0];i&&t(i)},c=o?e("input",{ref:s,id:"fileInput"+a,className:"hidden",accept:"image/*,video/*;capture=camera",onChange:u=>n(u),type:"file",capture:o}):e("input",{ref:s,id:"fileInput"+a,type:"file",className:"hidden",accept:"image/*,video/*;",onChange:u=>n(u)});return m(C,{children:[e("label",{htmlFor:"fileInput"+a,className:`fa-solid h-fit ${a} hover:bg-[#4444] hover:rounded-full p-2 cursor-pointer`}),c,!!r&&e(Z,{clearFile:()=>{t(null),s.current.value=""},file:r})]})},Y=({register:r})=>m("div",{className:"input-group relative grow",children:[e("textarea",{cols:20,rows:1,placeholder:"Message",className:"w-full text-black rounded-3xl border-none outline-none pl-4 pr-[2.25rem] py-1 max-h-[225px] text-lg sm:2xl  bg-gray-300 resize-none overflow-hidden dark:bg-[#3A3B3C] dark:text-[#E4E6EB]",...r("msg"),onInput:t=>M.auto_height(t.target),onKeyDown:t=>{t.key==="Enter"&&!t.shiftKey&&t.preventDefault()}}),e("span",{className:"fa-solid h-fit fa-face-smile absolute right-4 top-[0.65rem] sm:top-[0.65rem] hover:cursor-not-allowed"})]}),q=({addMessage:r})=>e("span",{className:"fa-solid fa-thumbs-up h-fit cursor-pointer hover:bg-[#4444] hover:rounded-full p-2",onClick:()=>{const t=E.getEmpyMessage("\u{1F44D}");r(t)}}),J=()=>{const r=b(),{curChat:t,chats:a}=v(h=>h.chatReducer),[o,s]=d.exports.useState(null),n=a?.find(h=>h.chatId===t?._id),c=h=>{if(!!h)return h.type.startsWith("image/")?"img":"video"},u=h=>{r(N({...h,file:null,timestamp:Date.now()},t._id,n))},i=window.navigator.userAgent.indexOf("Mobile")!==-1,p=h=>{h.preventDefault();const S=E.getEmpyMessage(x),_=c(o),A={...S,file:o,timestamp:Date.now(),type:_};r(N(A,t._id,n)),f()},{register:l,resetForm:f}=L({msg:""},()=>{}),{value:x}=l("msg");return m("form",{className:"w-full flex relative",onKeyDown:h=>{h.key==="Enter"&&!h.shiftKey&&p(h)},onSubmit:p,children:[!x&&!o&&e(O,{}),i&&!x&&e(k,{file:o,className:"fa-camera",setFile:s,capture:"environment"}),e(k,{file:o,className:"fa-image",setFile:s}),e(Y,{register:l}),x||o?e("button",{className:"fa-solid fa-paper-plane  h-fit cursor-pointer hover:bg-[#4444] hover:rounded-full p-2"}):"",!x&&!o&&e(q,{addMessage:u})]})},Q=()=>e("footer",{className:"send-bar p-2 text-lg text-blue-600 sm:text-xl",children:e(J,{})}),te=r=>{const[t,a]=d.exports.useState(null),s=U().pathname.split("/").at(-1),n=b();return d.exports.useEffect(()=>{if(!s)return;w.emit(y.SET_TOPIC,s),t&&t.abort();const c=new AbortController;return a(c),n(W(s,c.signal)),()=>{n($())}},[s]),d.exports.useEffect(()=>(w.on(y.SERVER_EMIT_ADD_MESSAGE,c=>n(z(c))),()=>w.off(y.SERVER_EMIT_ADD_MESSAGE)),[]),m("section",{className:"chat flex flex-col full-vh dark:bg-[#242526] dark:text-white",children:[e(K,{className:r.className}),e(P,{}),e(Q,{})]})};export{te as default};
