import{u as v,a as x,r as l,j as f,b as e,L as A,c as I,F as C,s as T,d as D,e as F}from"./index.34db1979.js";import{g as U,A as B,u as M,c as E,a as N,b as j,s as b,I as w,d as L,e as $,f as z}from"./useFormRegister.90b13d1e.js";const W=({className:r})=>{const s=v(),{curChat:n}=x(o=>o.chatReducer);l.exports.useEffect(()=>{s(U(n?.userId??""))},[n?._id]);const a=x(o=>o.chatReducer.curContact),t="/chats/";return f("header",{className:`chat-header shadow-[inset_0_0_4px] shadow-[#00000033] items-center flex justify-around p-2 text-lg sm:text-xl ${r} dark:shadow-[#ffffff33]`,children:[e(A,{to:t,children:e("span",{className:"fa-solid text-blue-600 fa-arrow-left cursor-pointer hover:bg-[#4444] hover:rounded-full p-2"})}),f("div",{className:"flex grow ml-8 items-center",children:[e(B,{imgSize:"md",imgUrl:a?.photo||""}),e("span",{className:"ml-4",children:a?.fullname})]}),e("span",{className:"fa-solid fa-circle-info text-blue-600 cursor-pointer hover:bg-[#4444] p-2 hover:rounded-full hover:cursor-not-allowed"})]})},H=({txt:r,url:s,type:n,fromUser:a,id:t})=>{const o=I.getLoggedInUser(),c=new RegExp("^(http[s]?:\\/\\/(www\\.)?|ftp:\\/\\/(www\\.)?|(www\\.)?){1}([0-9A-Za-z-\\.@:%_+~#=]+)+((\\.[a-zA-Z]{2,3})+)(/(.)*)?(\\?(.)*)?"),p=r?.split(" "),i=n?{video:e("video",{className:"rounded-lg",controls:!0,src:s}),img:e("img",{loading:"lazy",className:"rounded-lg",src:s}),audio:e("audio",{controls:!0,src:s})}[n]:"";return e("div",{className:"msg grid py-2",style:{gridTemplateColumns:a!==o._id?"300px 1fr":"1fr 300px"},children:f("div",{className:`w-fit ${a!==o._id?"col-start-1 dark:text-white":"col-start-2 text-righ text-white justify-self-end"}`,children:[!!n&&e("div",{children:i}),r&&e("p",{className:`p-3 rounded-full ${a!==o._id?"bg-[#E4E6EB] dark:bg-[#3E4042]":"bg-[rgb(0,132,255)]"}`,children:p.map((d,m)=>d.match(c)?e("a",{target:"_blank",className:"underline",href:d,children:d+" "},d+m+t):e("span",{children:d+" "},d+m+t))})]})})},P=()=>{const r=l.exports.useRef(null),s=()=>{const t=r.current;t.scrollTop=t.scrollHeight},{curChat:n}=x(t=>t.chatReducer);l.exports.useEffect(()=>{s()},[n?._id,n?.messages.length]);const a=n?.messages;return e("div",{ref:r,className:"msg-list grow px-4 py-2 overflow-y-auto",children:a&&a.map(t=>e(H,{fromUser:t.fromUser,id:t.id,txt:t.txt,type:t.type,url:t.url},t.id))})};let g,R;const G=()=>{const r=l.exports.useRef([]),[s,n]=l.exports.useState("idle"),[a,t]=l.exports.useState(null),[o,c]=l.exports.useState("");return{startRecording:()=>{s==="idle"&&navigator.mediaDevices.getUserMedia({audio:!0}).then(i=>{R=i,g=new MediaRecorder(i),g.start(),g.onstart=()=>n("recording"),g.ondataavailable=({data:d})=>r.current.push(d)}).catch(i=>c(i))},stopRecording:()=>{s!=="idle"&&(g.stop(),g.onstop=()=>{const i=new Blob(r.current,{type:"audio/webm;"});r.current=[],i.id=M.makeId(),t(i),n("idle"),R.getAudioTracks().forEach(d=>d.stop())})},audioResult:a,errorMessage:o,status:s}};const O=()=>{const r=v(),{curChat:s,chats:n}=x(u=>u.chatReducer),a=n?.find(u=>u.chatId===s?._id),{startRecording:t,stopRecording:o,audioResult:c,status:p}=G();return l.exports.useEffect(()=>{if(!c)return;const u=E.getEmpyMessage();r(N({...u,file:c,type:"audio",timestamp:Date.now()},s._id,a))},[c?.id]),e(C,{children:e("span",{title:"Click and Hold",onTouchStart:()=>t(),onMouseDown:()=>t(),onTouchEnd:()=>o(),onMouseUp:()=>o(),className:`fa-solid fa-microphone ${p==="idle"?"":"blink"} cursor-pointer hover:bg-[#4444] hover:rounded-full h-fit p-2`})})},V=({file:r,clearFile:s})=>{const n="absolute bottom-14 left-[50%] translate-x-[-50%]",a="fa-solid cursor-pointer fa-times absolute bottom-32 right-[-15%]",t="max-w-[350px] object-contain h-[150px]",[o,c]=l.exports.useState(null),p=v();return l.exports.useEffect(()=>{if(!r)return;const u=new Worker("/src/services/base64.worker.ts");return u.postMessage(r),u.onmessage=i=>{const{data:{type:d,data:m}}=i;return d==="success"?c(m):(s(),p(T({type:"error",txt:m})))},()=>{u.terminate()}},[r]),r.type.startsWith("video/")&&o?f("div",{className:n,children:[e("video",{className:t,controls:!0,src:o}),e("span",{onClick:()=>s(),className:a})]}):r.type.startsWith("image/")&&o?f("div",{className:n,children:[e("img",{className:t,src:o,alt:""}),e("span",{onClick:()=>s(),className:a})]}):o===null?f("div",{className:n,children:[e(D,{}),";"]}):e("div",{className:"absolute bottom-14",children:"File is not supported"})},y=({file:r,setFile:s,className:n,capture:a})=>{const t=l.exports.useRef(null),o=c=>{const p=c.target.files?.[0];p&&s(p)};return f(C,{children:[e("label",{htmlFor:"fileInput",className:`fa-solid h-fit ${n} hover:bg-[#4444] hover:rounded-full p-2 cursor-pointer`}),e("input",{ref:t,id:"fileInput",className:"hidden",accept:"image/*,video/*",onChange:c=>o(c),type:"file",capture:a}),!!r&&e(V,{clearFile:()=>{s(null),t.current.value=""},file:r})]})},Z=({register:r})=>f("div",{className:"input-group relative grow",children:[e("textarea",{cols:20,rows:1,placeholder:"Message",className:"w-full text-black rounded-3xl border-none outline-none pl-4 pr-[2.25rem] py-1 max-h-[225px] text-lg sm:2xl  bg-gray-300 resize-none overflow-hidden dark:bg-[#3A3B3C] dark:text-[#E4E6EB]",...r("msg"),onInput:s=>M.auto_height(s.target)}),e("span",{className:"fa-solid h-fit fa-face-smile absolute right-4 top-[0.65rem] sm:top-[0.65rem] hover:cursor-not-allowed"})]}),q=({addMessage:r})=>e("span",{className:"fa-solid fa-thumbs-up h-fit cursor-pointer hover:bg-[#4444] hover:rounded-full p-2",onClick:()=>{const s=E.getEmpyMessage("\u{1F44D}");r(s)}}),J=()=>{const r=v(),{curChat:s,chats:n}=x(h=>h.chatReducer),[a,t]=l.exports.useState(null),o=n?.find(h=>h.chatId===s?._id),c=h=>{if(!!h)return h.type.startsWith("image/")?"img":"video"},p=h=>{r(N({...h,file:null,timestamp:Date.now()},s._id,o))},u=window.navigator.userAgent.indexOf("Mobile")!==-1,{register:i,resetForm:d}=j({msg:""},()=>{}),{value:m}=i("msg");return f("form",{className:"w-full flex relative",onSubmit:h=>{h.preventDefault();const k=E.getEmpyMessage(m),S=c(a),_={...k,file:a,timestamp:Date.now(),type:S};r(N(_,s._id,o)),d()},children:[!m&&!a&&e(O,{}),u&&!m&&e(y,{file:a,className:"fa-camera",setFile:t,capture:"environment"}),e(y,{file:a,className:"fa-image",setFile:t}),e(Z,{register:i}),m||a?e("button",{className:"fa-solid fa-paper-plane  h-fit cursor-pointer hover:bg-[#4444] hover:rounded-full p-2"}):"",!m&&!a&&e(q,{addMessage:p})]})},K=()=>e("footer",{className:"send-bar p-2 text-lg text-blue-600 sm:text-xl",children:e(J,{})}),Y=r=>{const[s,n]=l.exports.useState(null),t=F().pathname.split("/").at(-1),o=v();return l.exports.useEffect(()=>{if(!t)return;b.emit(w.SET_TOPIC,t),s&&s.abort();const c=new AbortController;return n(c),o(L(t,c.signal)),()=>{o($())}},[t]),l.exports.useEffect(()=>(b.on(w.SERVER_EMIT_ADD_MESSAGE,c=>o(z(c))),()=>b.off(w.SERVER_EMIT_ADD_MESSAGE)),[]),f("section",{className:"chat flex flex-col min-h-screen h-screen dark:bg-[#242526] dark:text-white",children:[e(W,{className:r.className}),e(P,{}),e(K,{})]})};export{Y as default};
