import{u as b,a as v,r as d,j as m,b as e,L as I,c as D,F as C,s as T,d as F,e as U}from"./index.110170c7.js";import{g as B,A as j,u as M,c as E,a as N,b as L,s as w,I as y,d as $,e as z,f as K}from"./useFormRegister.4f95f7ff.js";const W=({className:r})=>{const t=b(),{curChat:o}=v(n=>n.chatReducer);d.exports.useEffect(()=>{t(B(o?.userId??""))},[o?._id]);const a=v(n=>n.chatReducer.curContact),s="/chats/";return m("header",{className:`chat-header shadow-[inset_0_0_4px] shadow-[#00000033] items-center flex justify-around p-2 text-lg sm:text-xl ${r} dark:shadow-[#ffffff33]`,children:[e(I,{to:s,children:e("span",{className:"fa-solid text-blue-600 fa-arrow-left cursor-pointer hover:bg-[#4444] hover:rounded-full p-2"})}),m("div",{className:"flex grow ml-8 items-center",children:[e(j,{imgSize:"md",imgUrl:a?.photo||""}),e("span",{className:"ml-4",children:a?.fullname})]}),e("span",{className:"fa-solid fa-circle-info text-blue-600 cursor-pointer hover:bg-[#4444] p-2 hover:rounded-full hover:cursor-not-allowed"})]})},H=({txt:r,url:t,type:o,fromUser:a,id:s})=>{const n=D.getLoggedInUser(),c=new RegExp("^(http[s]?:\\/\\/(www\\.)?|ftp:\\/\\/(www\\.)?|(www\\.)?){1}([0-9A-Za-z-\\.@:%_+~#=]+)+((\\.[a-zA-Z]{2,3})+)(/(.)*)?(\\?(.)*)?"),u=r?.split(" "),p=o?{video:e("video",{className:"rounded-lg",controls:!0,src:t}),img:e("img",{loading:"lazy",className:"rounded-lg",src:t}),audio:m("audio",{controls:!0,children:[e("source",{src:t,type:"audio/webm"}),e("source",{src:t,type:"audio/mpeg"}),e("source",{src:t,type:"audio/aac"}),e("source",{src:t,type:"audio/ogg"}),e("source",{src:t,type:"audio/wav"}),"Your browser does not support the audio tag"]})}[o]:"";return e("div",{className:"msg grid py-2",style:{gridTemplateColumns:a!==n._id?"300px 1fr":"1fr 300px"},children:m("div",{className:`w-fit ${a!==n._id?"col-start-1 dark:text-white":"col-start-2 text-righ text-white justify-self-end"}`,children:[!!o&&e("div",{children:p}),r&&e("p",{className:`p-3 rounded-full ${a!==n._id?"bg-[#E4E6EB] dark:bg-[#3E4042]":"bg-[rgb(0,132,255)]"}`,children:u.map((l,f)=>l.match(c)?e("a",{target:"_blank",className:"underline",href:l,children:l+" "},l+f+s):e("span",{children:l+" "},l+f+s))})]})})},P=()=>{const r=d.exports.useRef(null),t=()=>{const s=r.current;s.scrollTop=s.scrollHeight},{curChat:o}=v(s=>s.chatReducer);d.exports.useEffect(()=>{t()},[o?._id,o?.messages.length]);const a=o?.messages;return e("div",{ref:r,className:"msg-list grow px-4 py-2 overflow-y-auto",children:a&&a.map(s=>e(H,{fromUser:s.fromUser,id:s.id,txt:s.txt,type:s.type,url:s.url},s.id))})};let g,R;const G=()=>{const r=d.exports.useRef([]),[t,o]=d.exports.useState("idle"),[a,s]=d.exports.useState(null),[n,c]=d.exports.useState("");return{startRecording:()=>{t==="idle"&&navigator.mediaDevices.getUserMedia({audio:!0}).then(p=>{R=p,g=new MediaRecorder(p),g.start(),g.onstart=()=>o("recording"),g.ondataavailable=({data:l})=>r.current.push(l)}).catch(p=>c(p))},stopRecording:()=>{t!=="idle"&&(g.stop(),g.onstop=()=>{const p=new Blob(r.current,{type:"audio/webm;"});r.current=[],p.id=M.makeId(),s(p),o("idle"),R.getAudioTracks().forEach(l=>l.stop())})},audioResult:a,errorMessage:n,status:t}};const O=()=>{const r=b(),{curChat:t,chats:o}=v(i=>i.chatReducer),a=o?.find(i=>i.chatId===t?._id),{startRecording:s,stopRecording:n,audioResult:c,status:u}=G();return d.exports.useEffect(()=>{if(!c)return;const i=E.getEmpyMessage();r(N({...i,file:c,type:"audio",timestamp:Date.now()},t._id,a))},[c?.id]),e(C,{children:e("span",{title:"Click and Hold",onTouchStart:()=>s(),onMouseDown:()=>s(),onTouchEnd:()=>n(),onMouseUp:()=>n(),className:`fa-solid fa-microphone ${u==="idle"?"":"blink"} cursor-pointer hover:bg-[#4444] hover:rounded-full h-fit p-2`})})},V=({file:r,clearFile:t})=>{const o="absolute bottom-14 left-[50%] translate-x-[-50%]",a="fa-solid cursor-pointer fa-times absolute bottom-32 right-[-15%]",s="max-w-[350px] object-contain h-[150px]",[n,c]=d.exports.useState(null),u=b();return d.exports.useEffect(()=>{if(!r)return;const i=new Worker("/src/services/base64.worker.ts");return i.postMessage(r),i.onmessage=p=>{const{data:{type:l,data:f}}=p;return l==="success"?c(f):(t(),u(T({type:"error",txt:f})))},()=>{i.terminate()}},[r]),r.type.startsWith("video/")&&n?m("div",{className:o,children:[e("video",{className:s,controls:!0,src:n}),e("span",{onClick:()=>t(),className:a})]}):r.type.startsWith("image/")&&n?m("div",{className:o,children:[e("img",{className:s,src:n,alt:""}),e("span",{onClick:()=>t(),className:a})]}):n===null?m("div",{className:o,children:[e(F,{}),";"]}):e("div",{className:"absolute bottom-14",children:"File is not supported"})},k=({file:r,setFile:t,className:o,capture:a})=>{const s=d.exports.useRef(null),n=u=>{const i=u.target.files?.[0];i&&t(i)},c=a?e("input",{ref:s,id:"fileInput"+o,className:"hidden",accept:"image/*,video/*;capture=camera",onChange:u=>n(u),type:"file",capture:a}):e("input",{ref:s,id:"fileInput"+o,type:"file",className:"hidden",accept:"image/*,video/*;",onChange:u=>n(u)});return m(C,{children:[e("label",{htmlFor:"fileInput"+o,className:`fa-solid h-fit ${o} hover:bg-[#4444] hover:rounded-full p-2 cursor-pointer`}),c,!!r&&e(V,{clearFile:()=>{t(null),s.current.value=""},file:r})]})},Z=({register:r})=>m("div",{className:"input-group relative grow",children:[e("textarea",{cols:20,rows:1,placeholder:"Message",className:"w-full text-black rounded-3xl border-none outline-none pl-4 pr-[2.25rem] py-1 max-h-[225px] text-lg sm:2xl  bg-gray-300 resize-none overflow-hidden dark:bg-[#3A3B3C] dark:text-[#E4E6EB]",...r("msg"),onInput:t=>M.auto_height(t.target),onKeyDown:t=>{t.key==="Enter"&&!t.shiftKey&&t.preventDefault()}}),e("span",{className:"fa-solid h-fit fa-face-smile absolute right-4 top-[0.65rem] sm:top-[0.65rem] hover:cursor-not-allowed"})]}),Y=({addMessage:r})=>e("span",{className:"fa-solid fa-thumbs-up h-fit cursor-pointer hover:bg-[#4444] hover:rounded-full p-2",onClick:()=>{const t=E.getEmpyMessage("\u{1F44D}");r(t)}}),q=()=>{const r=b(),{curChat:t,chats:o}=v(h=>h.chatReducer),[a,s]=d.exports.useState(null),n=o?.find(h=>h.chatId===t?._id),c=h=>{if(!!h)return h.type.startsWith("image/")?"img":"video"},u=h=>{r(N({...h,file:null,timestamp:Date.now()},t._id,n))},i=window.navigator.userAgent.indexOf("Mobile")!==-1,p=h=>{h.preventDefault();const S=E.getEmpyMessage(x),_=c(a),A={...S,file:a,timestamp:Date.now(),type:_};r(N(A,t._id,n)),f()},{register:l,resetForm:f}=L({msg:""},()=>{}),{value:x}=l("msg");return m("form",{className:"w-full flex relative",onKeyDown:h=>{h.key==="Enter"&&!h.shiftKey&&p(h)},onSubmit:p,children:[!x&&!a&&e(O,{}),i&&!x&&e(k,{file:a,className:"fa-camera",setFile:s,capture:"environment"}),e(k,{file:a,className:"fa-image",setFile:s}),e(Z,{register:l}),x||a?e("button",{className:"fa-solid fa-paper-plane  h-fit cursor-pointer hover:bg-[#4444] hover:rounded-full p-2"}):"",!x&&!a&&e(Y,{addMessage:u})]})},J=()=>e("footer",{className:"send-bar p-2 text-lg text-blue-600 sm:text-xl",children:e(q,{})}),ee=r=>{const[t,o]=d.exports.useState(null),s=U().pathname.split("/").at(-1),n=b();return d.exports.useEffect(()=>{if(!s)return;w.emit(y.SET_TOPIC,s),t&&t.abort();const c=new AbortController;return o(c),n($(s,c.signal)),()=>{n(z())}},[s]),d.exports.useEffect(()=>(w.on(y.SERVER_EMIT_ADD_MESSAGE,c=>n(K(c))),()=>w.off(y.SERVER_EMIT_ADD_MESSAGE)),[]),m("section",{className:"chat flex flex-col full-vh dark:bg-[#242526] dark:text-white",children:[e(W,{className:r.className}),e(P,{}),e(J,{})]})};export{ee as default};
